{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "AWS CloudFormation Sample Template VPC_RDS_DB_Instance",
  "Parameters": {
    "VpcId": {
      "Type": "String",
      "Description": "VpcId of your existing Virtual Private Cloud (VPC)"
    },
    "Subnets": {
      "Type": "CommaDelimitedList",
      "Description": "The list of SubnetIds, for at least two Availability Zones in the region in your Virtual Private Cloud (VPC)"
    },
    "DBName": {
      "Default": "mydb",
      "Description": "The database name",
      "Type": "String",
      "MinLength": "1",
      "MaxLength": "64",
      "AllowedPattern": "[a-zA-Z][a-zA-Z0-9]*",
      "ConstraintDescription": "must begin with a letter and contain only alphanumeric characters."
    },
    "DBUsername": {
      "NoEcho": "true",
      "Description": "The database admin account username",
      "Type": "String",
      "MinLength": "1",
      "MaxLength": "16",
      "AllowedPattern": "[a-zA-Z][a-zA-Z0-9]*",
      "ConstraintDescription": "must begin with a letter and contain only alphanumeric characters."
    },
    "DBPassword": {
      "NoEcho": "true",
      "Description": "The database admin account password",
      "Type": "String",
      "MinLength": "8",
      "MaxLength": "41",
      "AllowedPattern": "[a-zA-Z0-9]*",
      "ConstraintDescription": "must contain only alphanumeric characters."
    },
    "DBClass": {
      "Default": "db.t2.micro",
      "Description": "Database instance class",
      "Type": "String",
      "AllowedValues": ["db.t2.micro", "db.t2.small"],
      "ConstraintDescription": "must select a valid database instance type."
    },
    "DBAllocatedStorage": {
      "Default": "5",
      "Description": "The size of the database (Gb)",
      "Type": "Number",
      "MinValue": "5",
      "MaxValue": "20",
      "ConstraintDescription": "must be between 5 and 20Gb."
    },
    "SecurityGroup": {
      "Type": "String",
      "Description": "ElasticBeanstalk Security group that can access Database"
    }
  },
  "Resources": {
    "DBSubnetGroup": {
      "Type": "AWS::RDS::DBSubnetGroup",
      "Properties": {
        "DBSubnetGroupDescription": "Subnets available for the RDS DB Instance",
        "SubnetIds": { "Ref": "Subnets" }
      }
    },
    "MyDB": {
      "Type": "AWS::RDS::DBInstance",
      "Properties": {
        "DBName": { "Ref": "DBName" },
        "AllocatedStorage": { "Ref": "DBAllocatedStorage" },
        "DBInstanceClass": { "Ref": "DBClass" },
        "Engine": "postgres",
        "EngineVersion": "9.3",
        "MasterUsername": { "Ref": "DBUsername" } ,
        "MasterUserPassword": { "Ref": "DBPassword" },
        "DBSubnetGroupName": { "Ref": "DBSubnetGroup" },
        "VPCSecurityGroups": [ { "Ref": "SecurityGroup" }  ]
      }
    }
  },
  "Outputs": {
    "DatabaseURL": {
      "Description": "URL of Database",
      "Value": {
        "Fn::Join": ["",
          [
            "postgres://",
            {"Ref": "DBUsername"},
            ":",
            {"Ref": "DBPassword"},
            "@",
            {"Fn::GetAtt": ["MyDB", "Endpoint.Address"]},
            ":",
            {"Fn::GetAtt": ["MyDB", "Endpoint.Port"]},
            "/",
            {"Ref": "DBName"}
          ]
        ]
      }
    }
  }
}